---
title: 自定义Cloudflare节点
author: Mashiro
avatar: https://cdn.jsdelivr.net/gh/guohoo/blog-source@master/modules/avatar.jpg
authorLink: https://mashiro.nl
authorAbout: 懒人，没技术，自学中......
authorDesc: Love Mashiro forever!
categories: 技术
comments: true
date: 2020-06-16 22:33:00
tags: 
  - VULTR
  - Cloudflare
  - CDN
keywords: Cloudflare
description: 如果不是备案的"神奇"规则，才不会用Cloudflare来加速
photos: https://cdn.jsdelivr.net/gh/guohoo/blog-source@master/background/article-cover/58898122_p0.jpg
---


因为现在的博客是部署在VULTR的日本机房，走日本的ntt线路。平时裸连还好，但是一到晚高峰线路必炸。经常是打开网页一片白，什么都加载不出来，所以也是没办法，被迫用CDN来加速站点。

但是这里有个很坑的事情，要想接入国内的CDN，域名必须是备案的；域名要备案，又必须解析到国内的服务器......
那要是把站点搬回国内，我还要CDN来干嘛呢？→_→

辛辛苦苦把站点部署在国外主机，是不可能再用回国内的小水管啦！所以想出几个可行的方案

 1. 把静态资源部署在国内的服务器，接CDN加速  
    一票否决，因为没钱再买服务器，而且这样也做不到全站CDN
 2. 把域名绑在国内的便宜主机上，CDN回源指向原站  
    还是否决，原因同上
 3. 接入国外的CDN  
    思来想去还是决定用这个方案，穷建站只能这样了(小声逼逼~)

这里我选择的是Cloudflare，国外知名CDN服务提供商，还有免费的套餐。  
但是免费版是不支持CNAME接入的，只能任由别人分配节点。海外加速通常没太大问题，不过用来给国内用户加速就很尴尬了。众所周知，Cloudflare对于国内就是云减速，因为它分配的节点对国内用户真的不太友好。鉴于这种情况，我们就需要指定节点来部署CDN加速。通过CNAME接入的方法有两种，一是升级企业版套餐，二是加入`Cloudflare Partner`。此处用的是第二种方法。

## 接入Cloudflare Partner ##
选择一个靠谱的 `Cloudflare Partner`，加入后在别人的面板进行解析即可。(Partner很多，此处不列出)
要是你不放心，可以自己去申请一个[Partner资格][1]，然后搭建面板，不过现在不好申请了。
接入和解析的教程上网一搜就有，这里不再赘述，就讲几个重要的点
<ol>
<li>和在域名解析处填的记录一样，哪个域名要走CDN，就填哪个域名相应的记录。
<br>比如你在域名解析处有记录值为@，指向服务器IP的A记录，那么在面板就这样填写
<p><ul>
<li>记录值：@</li>
<li>类型：A</li>
<li>回源地址：服务器IP或任意一个解析到服务器的域名</li>
</ul></p>
</li>
<li>添加完成后系统会给出相应的CNAME记录值，把这条CNAME记录在域名解析处加上即可</li>
</ol>

**PS**：要先停掉域名解析原来的A记录，再加上CNAME记录，因为两者会冲突。

[详细教程][2]

## 线路优化 ##
这是最为重要的一步，因为我们要指定CDN节点来加速国内访问速度，避免Cloudflare的自动分配。
到域名解析处添加A记录解析，线路类型自行设置，记录值填你想要指定Cloudflare节点的IP。
下面给出网上搜集的一些节点，如果你知道其他好用的节点也欢迎在评论区补充

 - 移动
   香港节点就OK了，例如`1.0.0.0-254`，`1.1.1.0-254`或者`172.64.32.*`
 - 联通
   试了很多节点，没有很满意的，都在160ms~190ms这个区间，目前用的是圣何塞`104.16.160.*`
 - 电信
   也没有推荐的，和联通一样走圣何塞`104.23.240.0-104.23.243.254`
 - 与百度云合作的节点
```
162.159.211.4-103        103.21.244.0/22         162.159.208.4-162.159.208.103
103.22.200.0/22          103.31.4.0/22           162.159.209.4-162.159.209.103
104.16.0.0/12            108.162.192.0/18        162.159.210.4-162.159.210.103
131.0.72.0/22            141.101.64.0/18         162.159.211.4-162.159.211.103
162.158.0.0/15           172.64.0.0/13
173.245.48.0/20          188.114.96.0/20
190.93.240.0/20          197.234.240.0/22
198.41.128.0/17          141.101.115.1-254
```
可以在[IPIP][3]查看各地Ping值，还可以进行路由跟踪。

## 题外话 ##
其实我个人是不介意备案的，但是目前的备案制度实在令人窒息，它不仅把域名和人绑在一起，连带主机商也要一块掺和进来。一旦出事的话，政府不仅要找到网站的所有人，还要找到网站的接入商，方便第一时间把你网线给拔了。当然这不是说网站应该不被监管，但是绑定国内主机这一条规则真的太僵硬了，让想备案的人都望而却步。

最后引用阮一峰老师的一段话作结：

> 几十年以后，或者几个世纪以后，回顾这段历史的时候，大家会觉得网站备案、GFW、绿坝软件、诸如此类的事情，都是好事，因为它们让许多中国青年认清了这个社会的本质，不再对旧制度抱有幻想，开始期盼新制度的到来，从而大大加快了社会变革的速度。

  [1]: https://www.cloudflare.com/partners/
  [2]: https://vircloud.net/operations/cf-cname.html
  [3]: https://www.ipip.net/